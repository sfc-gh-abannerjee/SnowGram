{
  "models": {
    "orchestration": "claude-sonnet-4-5"
  },
  "orchestration": {
    "budget": {
      "seconds": 90,
      "tokens": 40000
    }
  },
  "instructions": {
    "orchestration": "You are SnowGram, an AI that creates Snowflake architecture diagrams.\n\n**CRITICAL RULE FOR MEDALLION ARCHITECTURES:**\nWhen a user asks for a medallion architecture, bronze-silver-gold, lakehouse, or BI workload WITHOUT explicitly mentioning ANY of: S3, AWS, Azure, GCP, data lake, external storage, cloud storage, Snowpipe, Kafka, or ingestion from outside Snowflake:\n- DO NOT include S3, AWS S3, Snowpipe, Kafka, Azure Blob, or any external data sources\n- START the diagram from Bronze DB directly (not from external sources)\n- All nodes should be INSIDE Snowflake\n- DO NOT create an AWS Account boundary\n\nONLY include external sources (S3, Snowpipe, Kafka, Azure) if the user EXPLICITLY mentions:\n- S3, data lake, external, AWS, Azure, GCP, cloud storage, external ingestion, Snowpipe, Kafka\n\n**Component Type Validation:**\nFor component type lookup, use query_component_map_sv or map_component first.\nFor UNKNOWN components (no match found), use classify_component to get flow_stage positioning:\n- Returns: flow_stage (source/ingest/raw/transform/refined/serve/consume), flow_stage_order (0-6), flow_tier (external/snowflake/hybrid), suggested_icon\n- This enables automatic ELK.js layout positioning based on data flow\n\nAllowed types: Database, Schema, Table, View, Warehouse, Stream, Task.\n\n**OUTPUT FORMAT (ReactFlow-Ready JSON):**\nReturn a json code block with nodes and edges arrays. Each node MUST include: id, label, componentType, flowStage, flowStageOrder, position, layer, row, col.\n\n**INCLUDE flowStage and flowStageOrder in every node:**\n- If component type is known via map_component, derive flowStage from type\n- If component is unknown, call classify_component to get flowStage\n- flowStageOrder determines horizontal position in ELK.js layout\n\n**LAYOUT CALCULATION RULES:**\nUse grid-based positioning: baseX=100, baseY=180, colWidth=200, rowHeight=160\nPosition formula: x = baseX + (col * colWidth), y = baseY + (row * rowHeight)\n\n**HANDLE ASSIGNMENT RULES:**\nTarget RIGHT of source -> sourceHandle: right-source, targetHandle: left-target\nTarget BELOW source -> sourceHandle: bottom-source, targetHandle: top-target\nTarget LEFT of source -> sourceHandle: left-source, targetHandle: right-target\nTarget ABOVE source -> sourceHandle: top-source, targetHandle: bottom-target\n\n**EDGE CREATION RULES:**\nEvery edge MUST have source, target, sourceHandle, and targetHandle\nValidate node IDs exist before creating edges\n\nAlso return Mermaid fallback in mermaid code block for compatibility.\n\n**Layout Rules:**\nKeep direction left-to-right (LR) or top-down (TD)\nAvoid orphan nodes; ensure every node participates in the flow\nAlways include componentType and flowStage for every node"
  },
  "tools": [
    {
      "tool_spec": {
        "type": "cortex_search",
        "name": "SNOWFLAKE_DOCS_CKE",
        "description": "Search official Snowflake documentation via CKE (41,000+ pages)"
      }
    },
    {
      "tool_spec": {
        "type": "generic",
        "name": "SUGGEST_COMPONENTS_FOR_USE_CASE",
        "description": "AI-powered component recommendations (validate with CKE)",
        "input_schema": {
          "type": "object",
          "properties": {
            "user_description": {
              "type": "string"
            }
          },
          "required": [
            "user_description"
          ]
        }
      }
    },
    {
      "tool_spec": {
        "type": "generic",
        "name": "GET_ARCHITECTURE_BEST_PRACTICE",
        "description": "Cached best practices (CKE is primary source)",
        "input_schema": {
          "type": "object",
          "properties": {
            "use_case_keyword": {
              "type": "string"
            }
          },
          "required": [
            "use_case_keyword"
          ]
        }
      }
    },
    {
      "tool_spec": {
        "type": "generic",
        "name": "GENERATE_MERMAID_FROM_COMPONENTS",
        "description": "Generate Mermaid diagrams with Snowflake styling",
        "input_schema": {
          "type": "object",
          "properties": {
            "components": {
              "type": "array"
            },
            "connections": {
              "type": "array"
            }
          },
          "required": [
            "components",
            "connections"
          ]
        }
      }
    },
    {
      "tool_spec": {
        "type": "generic",
        "name": "VALIDATE_DIAGRAM_SYNTAX",
        "description": "Validate Mermaid syntax",
        "input_schema": {
          "type": "object",
          "properties": {
            "mermaid_code": {
              "type": "string"
            }
          },
          "required": [
            "mermaid_code"
          ]
        }
      }
    },
    {
      "tool_spec": {
        "type": "generic",
        "name": "query_component_map_sv",
        "description": "Semantic view lookup of synonyms to component_type",
        "input_schema": {
          "type": "object",
          "properties": {
            "pattern": {
              "type": "string",
              "description": "SQL LIKE pattern"
            },
            "limit": {
              "type": "integer",
              "default": 20
            }
          },
          "required": [
            "pattern"
          ]
        }
      }
    },
    {
      "tool_spec": {
        "type": "generic",
        "name": "map_component",
        "description": "Deterministic single-term lookup via UDF - returns component_type only",
        "input_schema": {
          "type": "object",
          "properties": {
            "word": {
              "type": "string"
            }
          },
          "required": [
            "word"
          ]
        }
      }
    },
    {
      "tool_spec": {
        "type": "generic",
        "name": "classify_component",
        "description": "AI-powered component classification for layout positioning. Returns flow_stage, flow_stage_order, flow_tier, suggested_icon. Use for UNKNOWN components not found in map_component. Cache-first: 75 cached components return instantly, unknown use LLM.",
        "input_schema": {
          "type": "object",
          "properties": {
            "component_name": {
              "type": "string",
              "description": "Name of the component to classify"
            }
          },
          "required": [
            "component_name"
          ]
        }
      }
    }
  ],
  "tool_resources": {
    "SNOWFLAKE_DOCS_CKE": {
      "search_service": "SNOWFLAKE_DOCUMENTATION.SHARED.CKE_SNOWFLAKE_DOCS_SERVICE",
      "max_results": 10,
      "columns": [
        "CHUNK",
        "DOCUMENT_TITLE",
        "SOURCE_URL"
      ]
    },
    "SUGGEST_COMPONENTS_FOR_USE_CASE": {
      "type": "function",
      "identifier": "SNOWGRAM_DB.CORE.SUGGEST_COMPONENTS_FOR_USE_CASE",
      "execution_environment": {
        "type": "warehouse",
        "warehouse": "COMPUTE_WH"
      }
    },
    "GET_ARCHITECTURE_BEST_PRACTICE": {
      "type": "function",
      "identifier": "SNOWGRAM_DB.CORE.GET_ARCHITECTURE_BEST_PRACTICE",
      "execution_environment": {
        "type": "warehouse",
        "warehouse": "COMPUTE_WH"
      }
    },
    "GENERATE_MERMAID_FROM_COMPONENTS": {
      "type": "function",
      "identifier": "SNOWGRAM_DB.CORE.GENERATE_MERMAID_FROM_COMPONENTS",
      "execution_environment": {
        "type": "warehouse",
        "warehouse": "COMPUTE_WH"
      }
    },
    "VALIDATE_DIAGRAM_SYNTAX": {
      "type": "function",
      "identifier": "SNOWGRAM_DB.CORE.VALIDATE_MERMAID_SYNTAX",
      "execution_environment": {
        "type": "warehouse",
        "warehouse": "COMPUTE_WH"
      }
    },
    "query_component_map_sv": {
      "type": "system_execute_sql",
      "sql_text": "SELECT COMPONENT_TYPE, SYNONYM FROM SEMANTIC_VIEW( SNOWGRAM_DB.CORE.COMPONENT_MAP_SV DIMENSIONS SYNONYMS.COMPONENT_TYPE, SYNONYMS.SYNONYM WHERE LOWER(SYNONYMS.SYNONYM) LIKE {{pattern}} ) LIMIT {{limit}};",
      "execution_environment": {
        "type": "warehouse",
        "warehouse": "COMPUTE_WH"
      }
    },
    "map_component": {
      "type": "system_execute_sql",
      "sql_text": "SELECT SNOWGRAM_DB.CORE.MAP_COMPONENT({{word}}) AS component_type;",
      "execution_environment": {
        "type": "warehouse",
        "warehouse": "COMPUTE_WH"
      }
    },
    "classify_component": {
      "type": "system_execute_sql",
      "sql_text": "SELECT SNOWGRAM_DB.CORE.CLASSIFY_COMPONENT({{component_name}}) AS classification;",
      "execution_environment": {
        "type": "warehouse",
        "warehouse": "COMPUTE_WH"
      }
    }
  }
}